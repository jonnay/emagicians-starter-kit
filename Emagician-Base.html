<?xml version="1.0" encoding="utf-8"?>
<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN"
"http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns="http://www.w3.org/1999/xhtml" lang="en" xml:lang="en">
<head>
<!-- 2018-05-18 Fri 10:31 -->
<meta http-equiv="Content-Type" content="text/html;charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Emagician-Base</title>
<meta name="generator" content="Org mode" />
<meta name="author" content="Jonathan Arkell" />
<style type="text/css">
 <!--/*--><![CDATA[/*><!--*/
  .title  { text-align: center;
             margin-bottom: .2em; }
  .subtitle { text-align: center;
              font-size: medium;
              font-weight: bold;
              margin-top:0; }
  .todo   { font-family: monospace; color: red; }
  .done   { font-family: monospace; color: green; }
  .priority { font-family: monospace; color: orange; }
  .tag    { background-color: #eee; font-family: monospace;
            padding: 2px; font-size: 80%; font-weight: normal; }
  .timestamp { color: #bebebe; }
  .timestamp-kwd { color: #5f9ea0; }
  .org-right  { margin-left: auto; margin-right: 0px;  text-align: right; }
  .org-left   { margin-left: 0px;  margin-right: auto; text-align: left; }
  .org-center { margin-left: auto; margin-right: auto; text-align: center; }
  .underline { text-decoration: underline; }
  #postamble p, #preamble p { font-size: 90%; margin: .2em; }
  p.verse { margin-left: 3%; }
  pre {
    border: 1px solid #ccc;
    box-shadow: 3px 3px 3px #eee;
    padding: 8pt;
    font-family: monospace;
    overflow: auto;
    margin: 1.2em;
  }
  pre.src {
    position: relative;
    overflow: visible;
    padding-top: 1.2em;
  }
  pre.src:before {
    display: none;
    position: absolute;
    background-color: white;
    top: -10px;
    right: 10px;
    padding: 3px;
    border: 1px solid black;
  }
  pre.src:hover:before { display: inline;}
  /* Languages per Org manual */
  pre.src-asymptote:before { content: 'Asymptote'; }
  pre.src-awk:before { content: 'Awk'; }
  pre.src-C:before { content: 'C'; }
  /* pre.src-C++ doesn't work in CSS */
  pre.src-clojure:before { content: 'Clojure'; }
  pre.src-css:before { content: 'CSS'; }
  pre.src-D:before { content: 'D'; }
  pre.src-ditaa:before { content: 'ditaa'; }
  pre.src-dot:before { content: 'Graphviz'; }
  pre.src-calc:before { content: 'Emacs Calc'; }
  pre.src-emacs-lisp:before { content: 'Emacs Lisp'; }
  pre.src-fortran:before { content: 'Fortran'; }
  pre.src-gnuplot:before { content: 'gnuplot'; }
  pre.src-haskell:before { content: 'Haskell'; }
  pre.src-hledger:before { content: 'hledger'; }
  pre.src-java:before { content: 'Java'; }
  pre.src-js:before { content: 'Javascript'; }
  pre.src-latex:before { content: 'LaTeX'; }
  pre.src-ledger:before { content: 'Ledger'; }
  pre.src-lisp:before { content: 'Lisp'; }
  pre.src-lilypond:before { content: 'Lilypond'; }
  pre.src-lua:before { content: 'Lua'; }
  pre.src-matlab:before { content: 'MATLAB'; }
  pre.src-mscgen:before { content: 'Mscgen'; }
  pre.src-ocaml:before { content: 'Objective Caml'; }
  pre.src-octave:before { content: 'Octave'; }
  pre.src-org:before { content: 'Org mode'; }
  pre.src-oz:before { content: 'OZ'; }
  pre.src-plantuml:before { content: 'Plantuml'; }
  pre.src-processing:before { content: 'Processing.js'; }
  pre.src-python:before { content: 'Python'; }
  pre.src-R:before { content: 'R'; }
  pre.src-ruby:before { content: 'Ruby'; }
  pre.src-sass:before { content: 'Sass'; }
  pre.src-scheme:before { content: 'Scheme'; }
  pre.src-screen:before { content: 'Gnu Screen'; }
  pre.src-sed:before { content: 'Sed'; }
  pre.src-sh:before { content: 'shell'; }
  pre.src-sql:before { content: 'SQL'; }
  pre.src-sqlite:before { content: 'SQLite'; }
  /* additional languages in org.el's org-babel-load-languages alist */
  pre.src-forth:before { content: 'Forth'; }
  pre.src-io:before { content: 'IO'; }
  pre.src-J:before { content: 'J'; }
  pre.src-makefile:before { content: 'Makefile'; }
  pre.src-maxima:before { content: 'Maxima'; }
  pre.src-perl:before { content: 'Perl'; }
  pre.src-picolisp:before { content: 'Pico Lisp'; }
  pre.src-scala:before { content: 'Scala'; }
  pre.src-shell:before { content: 'Shell Script'; }
  pre.src-ebnf2ps:before { content: 'ebfn2ps'; }
  /* additional language identifiers per "defun org-babel-execute"
       in ob-*.el */
  pre.src-cpp:before  { content: 'C++'; }
  pre.src-abc:before  { content: 'ABC'; }
  pre.src-coq:before  { content: 'Coq'; }
  pre.src-groovy:before  { content: 'Groovy'; }
  /* additional language identifiers from org-babel-shell-names in
     ob-shell.el: ob-shell is the only babel language using a lambda to put
     the execution function name together. */
  pre.src-bash:before  { content: 'bash'; }
  pre.src-csh:before  { content: 'csh'; }
  pre.src-ash:before  { content: 'ash'; }
  pre.src-dash:before  { content: 'dash'; }
  pre.src-ksh:before  { content: 'ksh'; }
  pre.src-mksh:before  { content: 'mksh'; }
  pre.src-posh:before  { content: 'posh'; }
  /* Additional Emacs modes also supported by the LaTeX listings package */
  pre.src-ada:before { content: 'Ada'; }
  pre.src-asm:before { content: 'Assembler'; }
  pre.src-caml:before { content: 'Caml'; }
  pre.src-delphi:before { content: 'Delphi'; }
  pre.src-html:before { content: 'HTML'; }
  pre.src-idl:before { content: 'IDL'; }
  pre.src-mercury:before { content: 'Mercury'; }
  pre.src-metapost:before { content: 'MetaPost'; }
  pre.src-modula-2:before { content: 'Modula-2'; }
  pre.src-pascal:before { content: 'Pascal'; }
  pre.src-ps:before { content: 'PostScript'; }
  pre.src-prolog:before { content: 'Prolog'; }
  pre.src-simula:before { content: 'Simula'; }
  pre.src-tcl:before { content: 'tcl'; }
  pre.src-tex:before { content: 'TeX'; }
  pre.src-plain-tex:before { content: 'Plain TeX'; }
  pre.src-verilog:before { content: 'Verilog'; }
  pre.src-vhdl:before { content: 'VHDL'; }
  pre.src-xml:before { content: 'XML'; }
  pre.src-nxml:before { content: 'XML'; }
  /* add a generic configuration mode; LaTeX export needs an additional
     (add-to-list 'org-latex-listings-langs '(conf " ")) in .emacs */
  pre.src-conf:before { content: 'Configuration File'; }

  table { border-collapse:collapse; }
  caption.t-above { caption-side: top; }
  caption.t-bottom { caption-side: bottom; }
  td, th { vertical-align:top;  }
  th.org-right  { text-align: center;  }
  th.org-left   { text-align: center;   }
  th.org-center { text-align: center; }
  td.org-right  { text-align: right;  }
  td.org-left   { text-align: left;   }
  td.org-center { text-align: center; }
  dt { font-weight: bold; }
  .footpara { display: inline; }
  .footdef  { margin-bottom: 1em; }
  .figure { padding: 1em; }
  .figure p { text-align: center; }
  .inlinetask {
    padding: 10px;
    border: 2px solid gray;
    margin: 10px;
    background: #ffffcc;
  }
  #org-div-home-and-up
   { text-align: right; font-size: 70%; white-space: nowrap; }
  textarea { overflow-x: auto; }
  .linenr { font-size: smaller }
  .code-highlighted { background-color: #ffff00; }
  .org-info-js_info-navigation { border-style: none; }
  #org-info-js_console-label
    { font-size: 10px; font-weight: bold; white-space: nowrap; }
  .org-info-js_search-highlight
    { background-color: #ffff00; color: #000000; font-weight: bold; }
  .org-svg { width: 90%; }
  /*]]>*/-->
</style>
<link href="https://fonts.googleapis.com/css?family=Inconsolata|Nixie+One|Taviraj:300,400" rel="stylesheet"><link href="./assets/styles/tufte-style.css" rel="stylesheet"><script src="https://use.fontawesome.com/432a2f463b.js"></script>
<script type="text/javascript">
/*
@licstart  The following is the entire license notice for the
JavaScript code in this tag.

Copyright (C) 2012-2018 Free Software Foundation, Inc.

The JavaScript code in this tag is free software: you can
redistribute it and/or modify it under the terms of the GNU
General Public License (GNU GPL) as published by the Free Software
Foundation, either version 3 of the License, or (at your option)
any later version.  The code is distributed WITHOUT ANY WARRANTY;
without even the implied warranty of MERCHANTABILITY or FITNESS
FOR A PARTICULAR PURPOSE.  See the GNU GPL for more details.

As additional permission under GNU GPL version 3 section 7, you
may distribute non-source (e.g., minimized or compacted) forms of
that code without the copy of the GNU GPL normally required by
section 4, provided you include this license notice and a URL
through which recipients can access the Corresponding Source.


@licend  The above is the entire license notice
for the JavaScript code in this tag.
*/
<!--/*--><![CDATA[/*><!--*/
 function CodeHighlightOn(elem, id)
 {
   var target = document.getElementById(id);
   if(null != target) {
     elem.cacheClassElem = elem.className;
     elem.cacheClassTarget = target.className;
     target.className = "code-highlighted";
     elem.className   = "code-highlighted";
   }
 }
 function CodeHighlightOff(elem, id)
 {
   var target = document.getElementById(id);
   if(elem.cacheClassElem)
     elem.className = elem.cacheClassElem;
   if(elem.cacheClassTarget)
     target.className = elem.cacheClassTarget;
 }
/*]]>*///-->
</script>
</head>
<body>
<div id="preamble" class="status">
<menu class="top"><a href="index.html"> Index </a><a href="Emagician.html"> Emagician </a><a href="Emagician-Base.html"> Base </a><a href="Emagician-Install.html"> Install </a><a href="Emagician-Meta.html"> Meta </a><a href="Interface.html"> Interface </a><a href="Programming.html"> Programming </a><a href="Text.html"> Text </a><a href="Org-Grimoire.html"> Org </a><a href="Lamp.html"> Lamp </a><a href="Journal.html"> Journal </a><a href="Snippets.html"> Snippets </a></menu><menu class="ext"><a class="dotnet" href="http://www.jonnay.net/">jonnay.net</a><a class="github" href="https://github.com/jonnay/emagicians-starter-kit">Fork on Github</a></menu>
</div>
<div id="content">
<h1 class="title">Emagician-Base</h1>
<div id="table-of-contents">
<h2>Table of Contents</h2>
<div id="text-table-of-contents">
<ul>
<li><a href="#org5931013">1. Bassline / Baseline</a></li>
<li><a href="#org059ddbe">2. Basic helpers</a></li>
<li><a href="#org532518a">3. Emacs Lisp Evaluation Environment</a>
<ul>
<li><a href="#org4dfef0e">3.1. Garbage Collection</a></li>
<li><a href="#orgb886716">3.2. Prefer new files</a></li>
<li><a href="#org61c51b9">3.3. Lexical Evaluation</a></li>
<li><a href="#orge8edba1">3.4. Common Lisp</a></li>
<li><a href="#org10d7dca">3.5. Evaluation and Printing</a></li>
<li><a href="#org31a72a7">3.6. Anaphoric Goodness</a></li>
<li><a href="#org7101cd5">3.7. Asyc</a></li>
<li><a href="#org68286f2">3.8. Testing</a></li>
<li><a href="#org9a8e918">3.9. Memory Usage</a></li>
</ul>
</li>
<li><a href="#org404e019">4. emagick-üê∞ Extensions to Emacs Lisp</a>
<ul>
<li><a href="#org5023e82">4.1. Test suite</a></li>
<li><a href="#org4eba860">4.2. alist-set: Change element in list</a></li>
</ul>
</li>
<li><a href="#orga551aab">5. Emagician Helpers</a>
<ul>
<li><a href="#org406730a">5.1. Hook Helpers</a>
<ul>
<li><a href="#orge39cd63">5.1.1. Minor In Major</a></li>
<li><a href="#org8554f90">5.1.2. Def hook</a>
<ul>
<li><a href="#org2780b8e">5.1.2.1. Unit tests</a></li>
</ul>
</li>
</ul>
</li>
<li><a href="#orgdde00cc">5.2. Backtrace Magick</a></li>
<li><a href="#org8938658">5.3. Sanitize File name</a></li>
<li><a href="#orgceaac27">5.4. Expect Dir</a></li>
<li><a href="#org2317285">5.5. Add to Path</a></li>
<li><a href="#org40cf2a7">5.6. Final Emagician Scratch</a>
<ul>
<li><a href="#org2b809d9">5.6.1. Scratchify</a></li>
<li><a href="#org84b69da">5.6.2. Reset Scratch</a></li>
<li><a href="#orgddcea02">5.6.3. Main Scratch Initiation</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</div>
</div>
<div id="outline-container-org5931013" class="outline-2">
<h2 id="org5931013"><span class="section-number-2">1</span> Bassline / Baseline</h2>
<div class="outline-text-2" id="text-1">
<p>
A baseline set of functions that are helpers for the rest of the Emagician Starter Kit.
</p>

<ul class="org-ul">
<li>Basic helpers in case there is a problem loading</li>
<li>Extend emacs lisp evaluation environment</li>
<li>emagick-üê∞ functions to further extend emacs lisp</li>
<li>Emagician helpers to make configuration much easier.</li>
</ul>
</div>
</div>

<div id="outline-container-org059ddbe" class="outline-2">
<h2 id="org059ddbe"><span class="section-number-2">2</span> Basic helpers</h2>
<div class="outline-text-2" id="text-2">
<p>
Just enough to make editing in a broken environment not a pain,
</p>

<pre class="code"><code>(<span class="org-keyword">require</span> '<span class="org-constant">ffap</span>)  <span class="org-comment-delimiter">; </span><span class="org-comment">Will be superceeded, but important when stuff gets broke.</span>
</code></pre>
</div>
</div>

<div id="outline-container-org532518a" class="outline-2">
<h2 id="org532518a"><span class="section-number-2">3</span> Emacs Lisp Evaluation Environment</h2>
<div class="outline-text-2" id="text-3">
<p>
There are helpers funcitons and variables that just make working with Emacs Lisp that much nicer.
</p>
</div>

<div id="outline-container-org4dfef0e" class="outline-3">
<h3 id="org4dfef0e"><span class="section-number-3">3.1</span> Garbage Collection</h3>
<div class="outline-text-3" id="text-3-1">
<div class="epigraph"><blockquote>
<p>
50 Megs, or 10 percent of the heap.  Seems legit.  It's original value is 800000.  Which seems like a lot, but its' really only 800 K.
</p>

<footer>Motherfucker-past-jonnay</footer></blockquote></div>

<p>
Resulting in this abomination:
</p>

<pre class="code"><code>(<span class="org-keyword">setq</span> gc-cons-threshold (* 500 1024 1024))
</code></pre>

<p>
There was even a little voice in my head that said "Maybe Jonnay, maybe you shouldn't fuck with the garbage collector?"
</p>

<p>
Which gave me these lessons:
</p>

<ul class="org-ul">
<li>Listen to that little voice, and</li>
<li>don't fuck around with garbage collection unless you know what you're doing and what you're setting.</li>
</ul>

<p>
One thing you can do is to set Garbage Collection to a high value during startup or execution of commands, and then set it back down to a reasonable value afterwards.  That doesn't change the timing of garbage collection only forstalls it for one big stoppa-tha-world.
</p>

<p>
Another option is to handle the setting of the GC value after a period of idle time.  This would be great for startup, but kinda horrible for command execution. 
</p>

<p>
<a href="http://bling.github.io/blog/2016/01/18/why-are-you-changing-gc-cons-threshold/">http://bling.github.io/blog/2016/01/18/why-are-you-changing-gc-cons-threshold/</a>
</p>

<pre class="code"><code>(<span class="org-keyword">defvar</span> <span class="org-variable-name">lou-the-gc-max</span> (* 512 1024 1024)
  <span class="org-doc">"Maximum Size of garbage collector.  Half gig seems reasonable.</span>
<span class="org-doc">This value is basically not sane."</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">lou-the-gc-sane</span> (car (get 'gc-cons-threshold 'standard-value))
  <span class="org-doc">"Sane GC Value, straight from The Yaks Mouth."</span>)

(<span class="org-keyword">defvar</span> <span class="org-variable-name">lou-is-chatty</span> t
  <span class="org-doc">"Whether or not Lou is chatty about debug messages"</span>)

(<span class="org-keyword">defun</span> <span class="org-function-name">lou-the-gc-go-crazy</span> ()
  <span class="org-doc">"Tell Lou the garbage collector to use maximum garbage size"</span>
  (<span class="org-keyword">when</span> lou-is-chatty
    (<span class="org-keyword">with-current-buffer</span> (messages-buffer)
      (<span class="org-keyword">let</span> ((inhibit-read-only t))
        (goto-char (point-max))
        (insert <span class="org-string">"\nLou is going crazy!"</span>))))
  (<span class="org-keyword">setq</span> gc-cons-threshold lou-the-gc-max))

(<span class="org-keyword">defun</span> <span class="org-function-name">lou-the-gc-be-sane</span> ()
  <span class="org-doc">"Tell Lou to stop acting crazy and use a sane garbage collection ammount"</span>
  (<span class="org-keyword">when</span> lou-is-chatty
    (<span class="org-keyword">with-current-buffer</span> (messages-buffer)
      (<span class="org-keyword">let</span> ((inhibit-read-only t))
        (goto-char (point-max))
        (insert <span class="org-string">"\nLou is sane again."</span>))))

  (<span class="org-keyword">setq</span> gc-cons-threshold lou-the-gc-sane))

(<span class="org-keyword">unless</span> after-init-time
  (lou-the-gc-go-crazy)
  (add-hook 'emacs-startup-hook #'lou-the-gc-be-sane t))

(add-hook 'minibuffer-setup-hook #'lou-the-gc-go-crazy)
(add-hook 'minibuffer-exit-hook #'lou-the-gc-be-sane)
</code></pre>
</div>
</div>


<div id="outline-container-orgb886716" class="outline-3">
<h3 id="orgb886716"><span class="section-number-3">3.2</span> Prefer new files</h3>
<div class="outline-text-3" id="text-3-2">
<pre class="code"><code>(<span class="org-keyword">setq</span> load-prefer-newer t)
</code></pre>
</div>
</div>

<div id="outline-container-org61c51b9" class="outline-3">
<h3 id="org61c51b9"><span class="section-number-3">3.3</span> Lexical Evaluation</h3>
<div class="outline-text-3" id="text-3-3">
<pre class="code"><code>(<span class="org-keyword">defmacro</span> <span class="org-function-name">lexically</span> (<span class="org-type">&amp;rest</span> forms)
  <span class="org-doc">"Lexically execute forms"</span>
  `(eval '(<span class="org-keyword">progn</span> ,@forms) t))
</code></pre>

<pre class="code"><code>(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">lexially</span> () 
  (<span class="org-keyword">should</span> (equal (macroexpand '(lexically t t t)) '(eval (<span class="org-keyword">quote</span> (<span class="org-keyword">progn</span> t t t)) t)))) 
</code></pre>
</div>
</div>

<div id="outline-container-orge8edba1" class="outline-3">
<h3 id="orge8edba1"><span class="section-number-3">3.4</span> Common Lisp</h3>
<div class="outline-text-3" id="text-3-4">
<p>
Sometimes the depricated CL environment is still required.  One day
this can go away. That day isn't today.
</p>

<pre class="code"><code>(<span class="org-keyword">require</span> '<span class="org-constant">cl</span>)
</code></pre>
</div>
</div>

<div id="outline-container-org10d7dca" class="outline-3">
<h3 id="org10d7dca"><span class="section-number-3">3.5</span> Evaluation and Printing</h3>
<div class="outline-text-3" id="text-3-5">
<pre class="code"><code>(<span class="org-keyword">setq</span> eval-expression-print-length 9000
      print-length 90000
      eval-expression-print-level 20
      print-level 900)
</code></pre>
</div>
</div>

<div id="outline-container-org31a72a7" class="outline-3">
<h3 id="org31a72a7"><span class="section-number-3">3.6</span> Anaphoric Goodness</h3>
<div class="outline-text-3" id="text-3-6">
<pre class="code"><code>(<span class="org-keyword">use-package</span> <span class="org-constant">anaphora</span>)
</code></pre>
</div>
</div>

<div id="outline-container-org7101cd5" class="outline-3">
<h3 id="org7101cd5"><span class="section-number-3">3.7</span> Asyc</h3>
<div class="outline-text-3" id="text-3-7">
<p>
Run commands asyncronously. 
</p>

<pre class="code"><code>(<span class="org-keyword">use-package</span> <span class="org-constant">async</span>)
</code></pre>
</div>
</div>

<div id="outline-container-org68286f2" class="outline-3">
<h3 id="org68286f2"><span class="section-number-3">3.8</span> Testing</h3>
<div class="outline-text-3" id="text-3-8">
<p>
ERT for testing.  Of course.
</p>

<p>
El-mock is too damn rubylike.  
</p>

<p>
Fakir is cool ass, but I don't need it.  yet.  Also, a great name
</p>

<pre class="code"><code>(<span class="org-keyword">use-package</span> <span class="org-constant">noflet</span>)
</code></pre>
</div>
</div>

<div id="outline-container-org9a8e918" class="outline-3">
<h3 id="org9a8e918"><span class="section-number-3">3.9</span> Memory Usage</h3>
<div class="outline-text-3" id="text-3-9">
<pre class="code"><code>(<span class="org-keyword">use-package</span> <span class="org-constant">memory-usage</span>)
</code></pre>
</div>
</div>
</div>

<div id="outline-container-org404e019" class="outline-2">
<h2 id="org404e019"><span class="section-number-2">4</span> emagick-üê∞ Extensions to Emacs Lisp</h2>
<div class="outline-text-2" id="text-4">
</div>
<div id="outline-container-org5023e82" class="outline-3">
<h3 id="org5023e82"><span class="section-number-3">4.1</span> Test suite</h3>
<div class="outline-text-3" id="text-4-1">
<pre class="code"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">emagician/meta/run-all-emagick-tests</span> ()
  <span class="org-doc">"Run all tests for emagick-&#128048;"</span> 
  (<span class="org-keyword">interactive</span>)
  (ert-run-tests-interactively <span class="org-string">"emagick"</span>))
</code></pre>
</div>
</div>

<div id="outline-container-org4eba860" class="outline-3">
<h3 id="org4eba860"><span class="section-number-3">4.2</span> alist-set: Change element in list</h3>
<div class="outline-text-3" id="text-4-2">
<pre class="code"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">emagick-&#128048;/alist-set</span> (key value alist <span class="org-type">&amp;optional</span> use-proper-list)
  <span class="org-doc">"Sets or adds KEY with VALUE on ALIST, and return the list.</span>
<span class="org-doc">If USE-PROPER-LIST is true then instead of a (dotted . list) a</span>
<span class="org-doc">(proper list) is constructed insted."</span>
  (<span class="org-keyword">let</span> ((list-frag (funcall (<span class="org-keyword">if</span> use-proper-list #'list #'cons)
                            key
                            value)))
    (<span class="org-keyword">if</span> (not (null alist))
        (cons list-frag
              (assq-delete-all key alist))
      (list list-frag))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagick-&#128048;/alist-set-on-empty-list</span> ()
  <span class="org-doc">""</span>
  (<span class="org-keyword">should</span> (equal (emagick-&#128048;/alist-set 'foo 'bar '())
                 '((foo . bar))))
  (<span class="org-keyword">should</span> (equal (emagick-&#128048;/alist-set 'foo 'bar '() t)
                 '((foo bar)))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagick-&#128048;/alist-set-on-list-with-element</span> ()
  <span class="org-doc">""</span>
  (<span class="org-keyword">should</span> (equal (emagick-&#128048;/alist-set 'baz 'blarg '((foo . bar)))
                 '((baz . blarg)(foo . bar))))
  (<span class="org-keyword">should</span> (equal (emagick-&#128048;/alist-set 'baz 'blarg '((foo bar)) t)
                 '((baz blarg)(foo bar)))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagick-&#128048;/alist-set-on-list-without-element</span> ()
  <span class="org-doc">""</span>
  (<span class="org-keyword">should</span> (equal (emagick-&#128048;/alist-set 'foo 'bar '((foo . baz)))
                 '((foo . bar))))
  (<span class="org-keyword">should</span> (equal (emagick-&#128048;/alist-set 'foo 'bar '((foo baz)) t)
                 '((foo bar)))))
</code></pre>
</div>
</div>
</div>

<div id="outline-container-orga551aab" class="outline-2">
<h2 id="orga551aab"><span class="section-number-2">5</span> Emagician Helpers</h2>
<div class="outline-text-2" id="text-5">
</div>
<div id="outline-container-org406730a" class="outline-3">
<h3 id="org406730a"><span class="section-number-3">5.1</span> Hook Helpers</h3>
<div class="outline-text-3" id="text-5-1">
</div>
<div id="outline-container-orge39cd63" class="outline-4">
<h4 id="orge39cd63"><span class="section-number-4">5.1.1</span> Minor In Major</h4>
<div class="outline-text-4" id="text-5-1-1">
<p>
Kinda one of those things that I am surprised is not a thing.
</p>

<pre class="code"><code>(<span class="org-keyword">defmacro</span> <span class="org-function-name">emagician/minor-in-major-mode</span> (minor-mode major-mode-hook)
  (<span class="org-keyword">let</span> ((turn-on-symbol (intern (concat <span class="org-string">"turn-on-"</span> (symbol-name minor-mode)))))
    (list 
     'progn 
     `(<span class="org-keyword">defun</span> ,turn-on-symbol ()
        <span class="org-doc">"Automagickally generated by emagicians starter kit."</span>
        (<span class="org-keyword">interactive</span>)
        (,minor-mode +1))
     `(add-hook (<span class="org-keyword">quote</span> ,major-mode-hook) (<span class="org-keyword">quote</span> ,turn-on-symbol)))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/test-minor-in-major-mode</span> ()
  <span class="org-doc">"emagician-minor-in-major macro test"</span>
  (<span class="org-keyword">should</span> (equal (macroexpand '(emagician/minor-in-major-mode paredit-mode elisp-mode-hook))
                 '(<span class="org-keyword">progn</span>
                    (<span class="org-keyword">defun</span> <span class="org-function-name">turn-on-paredit-mode</span> ()
                      <span class="org-doc">"Automagickally generated by emagicians starter kit."</span>
                      (<span class="org-keyword">interactive</span>)
                      (paredit-mode +1))
                    (add-hook 'elisp-mode-hook 'turn-on-paredit-mode))))
  (<span class="org-keyword">let</span> ((mode-hook '())
        (executed 0))
    (<span class="org-keyword">flet</span> ((emagician-minor-test (arg) (<span class="org-keyword">setq</span> executed (1+ executed))))
      (<span class="org-keyword">emagician/minor-in-major-mode</span> emagician-minor-test mode-hook)
      (<span class="org-keyword">emagician/minor-in-major-mode</span> emagician-minor-test mode-hook)
      (run-hooks 'mode-hook)
      (<span class="org-keyword">should</span> (= 1 executed))
      (<span class="org-keyword">should</span> (fboundp 'turn-on-emagician-minor-test))
      (fmakunbound 'turn-on-emagician-minor-test))))


(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/defhook-does-not-add-when-existant</span> ()
  (<span class="org-keyword">let</span> ((hook '())
        (executed 0))
    (<span class="org-keyword">emagician/defhook</span> test-hook hook
      (<span class="org-keyword">setq</span> executed (1+ executed)))
    (<span class="org-keyword">emagician/defhook</span> test-hook hook
      (<span class="org-keyword">setq</span> executed (1+ executed)))
    (run-hooks 'hook)
    (<span class="org-keyword">should</span> (= 1 executed))
    (fmakunbound 'test-hook)))
</code></pre>
</div>
</div>

<div id="outline-container-org8554f90" class="outline-4">
<h4 id="org8554f90"><span class="section-number-4">5.1.2</span> Def hook</h4>
<div class="outline-text-4" id="text-5-1-2">
<pre class="code"><code>(<span class="org-keyword">defmacro</span> <span class="org-function-name">emagician/defhook</span> (name hook <span class="org-type">&amp;rest</span> b)
  (<span class="org-keyword">declare</span> (indent 2))
  (<span class="org-keyword">let*</span> ((docp (stringp (car b)))
         (body (<span class="org-keyword">if</span> docp (cdr b) b)))
    `(<span class="org-keyword">progn</span> 
       (<span class="org-keyword">defun</span> ,name () 
         ,(concat (<span class="org-keyword">if</span> docp (car b) <span class="org-string">"Not Documented\n"</span>) <span class="org-string">"\nEmagically defined with emagician/defhook."</span>)
         ,@body)
       (<span class="org-keyword">when</span> (<span class="org-keyword">or</span> (not (boundp (<span class="org-keyword">quote</span> ,hook)))
                 (not (member (<span class="org-keyword">quote</span> ,name) ,hook)))
         (add-hook (<span class="org-keyword">quote</span> ,hook) (<span class="org-keyword">quote</span> ,name))))))
</code></pre>
</div>

<div id="outline-container-org2780b8e" class="outline-5">
<h5 id="org2780b8e"><span class="section-number-5">5.1.2.1</span> Unit tests</h5>
<div class="outline-text-5" id="text-5-1-2-1">
<pre class="code"><code>(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/defhook-defines-hook-and-adds-it</span> ()
  <span class="org-doc">"Basic test to make sure it defines the hook function and adds it."</span>
  (<span class="org-keyword">let</span> ((hook '())
        (executed nil))
    (<span class="org-keyword">emagician/defhook</span> test-hook hook
      (<span class="org-keyword">setq</span> executed t))
    (run-hooks 'hook)
    (<span class="org-keyword">should</span> (fboundp 'test-hook))
    (<span class="org-keyword">should</span> executed)
    (fmakunbound 'test-hook)))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/defhook-redefines-when-bound</span> ()
  (<span class="org-keyword">let</span> ((hook '())
        (executed nil)
        (rebound nil))
    (<span class="org-keyword">flet</span> ((test-hook () (<span class="org-keyword">setq</span> rebound nil)))
      (<span class="org-keyword">emagician/defhook</span> test-hook hook
        (<span class="org-keyword">setq</span> executed t)
        (<span class="org-keyword">setq</span> rebound t))
      (run-hooks 'hook)
      (<span class="org-keyword">should</span> executed)
      (<span class="org-keyword">should</span> rebound)
      (fmakunbound 'test-hook))))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/defhook-does-not-add-when-existant</span> ()
  (<span class="org-keyword">let</span> ((hook '())
        (executed 0))
    (<span class="org-keyword">emagician/defhook</span> test-hook hook
      (<span class="org-keyword">setq</span> executed (1+ executed)))
    (<span class="org-keyword">emagician/defhook</span> test-hook hook
      (<span class="org-keyword">setq</span> executed (1+ executed)))
    (run-hooks 'hook)
    (<span class="org-keyword">should</span> (= 1 executed))
    (fmakunbound 'test-hook)))
</code></pre>
</div>
</div>
</div>
</div>

<div id="outline-container-orgdde00cc" class="outline-3">
<h3 id="orgdde00cc"><span class="section-number-3">5.2</span> Backtrace Magick</h3>
<div class="outline-text-3" id="text-5-2">
<p>
HOLY SHIT. This worked better than I expected. 
</p>

<p>
This function snarfs the backtrace when called and returns it as a list.   This is used primarily for initialization testing.
</p>

<p>
(load-file-name or buffer-file-name)
</p>

<pre class="code"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">emagician/snarf-backtrace</span> ()
  <span class="org-doc">"Snarfs the backtrace as a list"</span>
  (<span class="org-keyword">let</span> ((num 3)
        (frames (cons (backtrace-frame 3) nil)))
    (<span class="org-keyword">while</span> (car frames)
      (<span class="org-keyword">when</span> (&gt; num 50) (<span class="org-warning">error</span> <span class="org-string">"Too many frames %S"</span> (pp frames)))
      (<span class="org-keyword">setq</span> num (1+ num))
      (<span class="org-keyword">setq</span> frames (cons (backtrace-frame (+ 3 num)) frames)))
    (cdr frames)))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/snarf-backtrace</span> ()
  (<span class="org-keyword">should</span> (equal '(t emagician/snarf-backtrace) (car (last (emagician/snarf-backtrace))))))
</code></pre>
</div>
</div>

<div id="outline-container-org8938658" class="outline-3">
<h3 id="org8938658"><span class="section-number-3">5.3</span> Sanitize File name</h3>
<div class="outline-text-3" id="text-5-3">
<p>
A bit of a naive version of this for now.
</p>

<pre class="code"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">emagician/sanitize-file-name</span> (str)
  (replace-regexp-in-string <span class="org-string">"[/~\000]"</span> <span class="org-string">"-"</span> str))

</code></pre>

<pre class="code"><code>(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/sanitize-file-name</span> ()
  (<span class="org-keyword">should</span> (equal <span class="org-string">""</span> (emagician/sanitize-file-name <span class="org-string">""</span>)))
  (<span class="org-keyword">should</span> (equal <span class="org-string">"foo"</span> (emagician/sanitize-file-name <span class="org-string">"foo"</span>)))
  (<span class="org-keyword">should</span> (equal <span class="org-string">"-foo"</span> (emagician/sanitize-file-name <span class="org-string">"/foo"</span>)))
  (<span class="org-keyword">should</span> (equal <span class="org-string">"-foo"</span> (emagician/sanitize-file-name <span class="org-string">"~foo"</span>))))
</code></pre>
</div>
</div>

<div id="outline-container-orgceaac27" class="outline-3">
<h3 id="orgceaac27"><span class="section-number-3">5.4</span> Expect Dir</h3>
<div class="outline-text-3" id="text-5-4">
<p>
Make sure a dirs exist.
</p>

<pre class="code"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">emagician/expect-dir</span> (dir <span class="org-type">&amp;optional</span> pathroot) 
  <span class="org-doc">"Ensures that the named directory exists."</span>
  (<span class="org-keyword">let</span> ((path (expand-file-name dir
                                (<span class="org-keyword">or</span> pathroot emagician/dir))))
    (<span class="org-keyword">when</span> (not (file-directory-p path))
      (<span class="org-keyword">when</span> (file-exists-p path)
        (<span class="org-warning">error</span> <span class="org-string">"Cannot Create %s, it already exists and is a file."</span> path))
      (make-directory path nil))
    path))

</code></pre>

<pre class="code"><code>(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/expect-dir</span> ()
  (<span class="org-keyword">let</span> ((tdir <span class="org-string">"emagician-expect-dir-scratch-monkey"</span>))   
    (<span class="org-keyword">should</span> (not (file-directory-p tdir)))
    (<span class="org-keyword">should</span> (file-directory-p (emagician/expect-dir <span class="org-string">"emagician-expect-dir-dummy-test-dir"</span>)))
    (<span class="org-keyword">should</span> (file-directory-p (emagician/expect-dir <span class="org-string">"emagician-expect-dir-dummy-test-dir"</span>)))
    (<span class="org-keyword">should</span> (<span class="org-keyword">progn</span> (delete-directory tdir) (not (file-directory-p tdir))))
    (<span class="org-keyword">should-error</span> (emagician/expect-dir <span class="org-string">"foo/bar/baz/notexisting"</span>)))
  (<span class="org-keyword">should-error</span> (emagician/expect-dir <span class="org-string">"Emagician.org"</span>)))

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/expect-dir-with-extra-arg</span> ()
  (<span class="org-keyword">let*</span> ((dirname <span class="org-string">"emagician-expect-dir-scratch-monkey"</span>)
         (tdir (concat temporary-file-directory dirname)))
    (<span class="org-keyword">should</span> (not (file-directory-p tdir)))
    (<span class="org-keyword">should</span> (file-directory-p (emagician/expect-dir dirname
                                                    temporary-file-directory)))
    (<span class="org-keyword">should</span> (<span class="org-keyword">progn</span> (delete-directory tdir)
                   (not (file-directory-p tdir))))))
</code></pre>
</div>
</div>

<div id="outline-container-org2317285" class="outline-3">
<h3 id="org2317285"><span class="section-number-3">5.5</span> Add to Path</h3>
<div class="outline-text-3" id="text-5-5">
<pre class="code"><code>  (<span class="org-keyword">defun</span> <span class="org-function-name">emagician/add-to-path</span> (path <span class="org-type">&amp;rest</span> front)
    <span class="org-doc">"Adds PATH to the PATH env variable, eshell-path-env as well as exec-path.</span>
<span class="org-doc">If FRONT is non nil, then PATH will be prepended to the env and shell vars.  </span>
<span class="org-doc">The exec-path always will always have it prepended. "</span>
    (<span class="org-keyword">let</span> ((shell-path (concat 
                       (<span class="org-keyword">if</span> front 
                           path
                         (getenv <span class="org-string">"PATH"</span>))
                       <span class="org-string">":"</span>
                       (<span class="org-keyword">if</span> front
                           (getenv <span class="org-string">"PATH"</span>)
                         path))))
      (setenv <span class="org-string">"PATH"</span> shell-path)
      (<span class="org-keyword">setq</span> eshell-path-env shell-path)
      (<span class="org-keyword">setq</span> exec-path (cons path exec-path))))

</code></pre>
</div>
</div>

<div id="outline-container-org40cf2a7" class="outline-3">
<h3 id="org40cf2a7"><span class="section-number-3">5.6</span> Final Emagician Scratch</h3>
<div class="outline-text-3" id="text-5-6">
<p>
When the starter kit is loaded we want to display the scratch buffer
with a new and improved scratch buffer giving some statistics, showing
inspirational messages, dire warnings, and apocalyptic screeds.
</p>

<p>
We also show a set of quick elisp commands that can be immediately run
by moving the point to the relevant line of elisp, and executing. 
</p>

<p>
This exemplifies everything that is good with Emacs. 
</p>

<p>
If you want to add items, you can do so through the
<code>emagician/scratch-links</code> variable.
</p>

<pre class="code"><code>(<span class="org-keyword">defvar</span> <span class="org-variable-name">emagician/scratch-links</span> `((magit-status ,emagician/dir))
  <span class="org-doc">"A list of elisp that is inserted in the scratch buffer at startup."</span>)
</code></pre>
</div>

<div id="outline-container-org2b809d9" class="outline-4">
<h4 id="org2b809d9"><span class="section-number-4">5.6.1</span> Scratchify</h4>
<div class="outline-text-4" id="text-5-6-1">
<pre class="code"><code>  (<span class="org-keyword">defun</span> <span class="org-function-name">emagician/scratchify-text</span> (text-or-list)
    <span class="org-doc">"Takes a chunk of text, and at the newline boundary inserts ;;;</span>
<span class="org-doc">If it's a list, then scratchify the list members."</span>
    (<span class="org-keyword">cond</span>
     ((null text-or-list) nil)
     ((<span class="org-keyword">and</span> (stringp text-or-list) (equal <span class="org-string">""</span> text-or-list))
      <span class="org-string">";;;\n"</span>)
     ((listp text-or-list)
      (mapconcat 'emagician/scratchify-text text-or-list <span class="org-string">""</span>))
     ((stringp text-or-list)
      (mapconcat (<span class="org-keyword">lambda</span> (line)
                   (format <span class="org-string">";;; </span><span class="org-outshine-level-1">%s\n" line))</span>
                 (split-string text-or-list <span class="org-string">"\n"</span>)
                 <span class="org-string">""</span>))))
</code></pre>

<pre class="code"><code>(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/scratchify-text-props</span> ()
  (<span class="org-keyword">should</span> (equal <span class="org-string">";;; </span><span class="org-outshine-level-1">foo\n" (emagician/scratchify-text (propertize "foo" 'face '(:foreground "red"))))))</span>

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/scratchify-text</span> ()
  (<span class="org-keyword">should</span> (equal <span class="org-string">";;; </span><span class="org-outshine-level-1">foo\n" (emagician/scratchify-text "foo")))</span>
  (<span class="org-keyword">should</span> (equal <span class="org-string">";;; </span><span class="org-outshine-level-1">Topes\n;;; \n" (emagician/scratchify-text "Topes\n"))))</span>

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/scratchify-list</span> ()
  (<span class="org-keyword">should</span> (equal <span class="org-string">";;; </span><span class="org-outshine-level-1">foo\n" (emagician/scratchify-text '("foo"))))</span>
  (<span class="org-keyword">should</span> (equal <span class="org-string">";;; </span><span class="org-outshine-level-1">foo\n;;; bar\n" (emagician/scratchify-text '("foo" "bar")))))</span>

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/scratchify-list-in-list</span> ()
  (<span class="org-keyword">should</span> (equal <span class="org-string">";;; </span><span class="org-outshine-level-1">foo\n;;; bar\n" (emagician/scratchify-text '("foo" ("bar"))))))</span>

(<span class="org-keyword">ert-deftest</span> <span class="org-function-name">emagician/scratchify-empty</span> ()
  (<span class="org-keyword">should</span> (equal <span class="org-string">";;;\n"</span> (emagician/scratchify-text <span class="org-string">""</span>))))
</code></pre>
</div>
</div>

<div id="outline-container-org84b69da" class="outline-4">
<h4 id="org84b69da"><span class="section-number-4">5.6.2</span> Reset Scratch</h4>
<div class="outline-text-4" id="text-5-6-2">
<pre class="code"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">emagician/reset-scratch</span> (str)
  (<span class="org-keyword">with-current-buffer</span> <span class="org-string">"*scratch*"</span>
    (lisp-interaction-mode)
    (font-lock-mode -1)
    (whitespace-mode -1)
    (erase-buffer)
    (insert str)))
</code></pre>
</div>
</div>

<div id="outline-container-orgddcea02" class="outline-4">
<h4 id="orgddcea02"><span class="section-number-4">5.6.3</span> Main Scratch Initiation</h4>
<div class="outline-text-4" id="text-5-6-3">
<pre class="code"><code>(<span class="org-keyword">defun</span> <span class="org-function-name">emagician/initiate-thee-scratch</span> ()
  (<span class="org-keyword">flet</span> ((with-bg-fg (str bg fg)
           (propertize str
                       'face
                       (list <span class="org-builtin">:background</span> bg <span class="org-builtin">:foreground</span> fg)))
         (with-fg (str fg)
           (propertize str
                       'face
                       (list <span class="org-builtin">:foreground</span> fg))))
    (<span class="org-keyword">let*</span> ((banner-color <span class="org-string">"DarkViolet"</span>)
           (info-label <span class="org-string">"DeepSkyBlue"</span>)
           (info-value <span class="org-string">"cyan"</span> )
           (banner-line (with-fg (make-string 72 ?&#9608;) banner-color))
           (header
            `(,banner-line
              ,(with-bg-fg <span class="org-string">"&#9608;&#9608;&#9608;&#9608;            &#128048;-|-+-|- Sekrut Alien Technology -|-+-|-&#128048;         &#9608;&#9608;&#9608;"</span> info-label banner-color)
              ,banner-line
              <span class="org-string">""</span>
              <span class="org-string">"     It is with the Quill of Echinda I scratch upon the beat mesa."</span>
              <span class="org-string">""</span>
              ,banner-line
              ,(concat (with-fg <span class="org-string">"Emacs Version:     "</span> info-label)
                       (with-fg emacs-version info-value))
              ,(concat (with-fg <span class="org-string">"Emagician Verison: "</span> info-label)
                       (with-fg emagician/version info-value))))
           (startup-time
            `(,banner-line
              ,(<span class="org-keyword">if</span> before-init-time
                   (concat (with-fg <span class="org-string">"&#128346; Startup Time:   "</span> info-label)
                           (with-fg (format <span class="org-string">"%.2f"</span> (- (float-time)
                                                      (float-time before-init-time)))
                                    info-value))
                 (propertize <span class="org-string">"&#8263; before-init-time is null!"</span> <span class="org-builtin">:face</span> 'error-face))
              ,(mapcar (<span class="org-keyword">lambda</span> (s) (format <span class="org-string">"  %65s %.2f"</span> (car s) (cdr s)))
                       emagician/slow-loaders)))
           (chaotic-wisdom
            `(,banner-line
              ,(emagician/cookie-from-file <span class="org-string">"assets/collected-works-ov-chaos.lines"</span>)))
           (minor-lamp-invocation
            `(,banner-line
              ,(emagician/cookie-from-file <span class="org-string">"assets/minor-lamp-invocation.lines"</span>)))
           (tools
            (mapconcat (<span class="org-keyword">lambda</span> (link )
                         (format <span class="org-string">"%S\n"</span> link))
                       emagician/scratch-links
                       <span class="org-string">""</span>)))
      (emagician/reset-scratch
       (concat (emagician/scratchify-text
                (list header
                      startup-time
                      chaotic-wisdom
                      minor-lamp-invocation
                      banner-line))
               <span class="org-string">"\n"</span>
               tools
               <span class="org-string">"\n"</span>
               (emagician/scratchify-text banner-line))))))
</code></pre>
</div>
</div>
</div>
</div>
</div>
<div id="postamble" class="status">
<p class="author">Author: Jonathan Arkell</p>
<p class="date">Created: 2018-05-18 Fri 10:31</p>
<p class="validation"><a href="http://validator.w3.org/check?uri=referer">Validate</a></p>
</div>
</body>
</html>
